# AI角色扮演网站 - 架构设计文档

## 系统架构概述

本项目采用微服务架构设计，分为前端、后端、AI代理三个主要服务，通过消息队列进行异步通信。

### 整体架构图
```
用户界面 (Next.js) 
    ↓ HTTP/WebSocket
后端服务 (Go + Gin) 
    ↓ RabbitMQ消息队列
AI代理服务 (Python + PocketFlow) 
    ↓ API调用
DeepSeek-V3 LLM模型
```

## 核心模块规格

### 1. 前端模块 (Frontend)

#### 技术栈
- **框架**: Next.js 14 + TypeScript
- **样式**: Tailwind CSS + shadcn/ui
- **状态管理**: React Context + Zustand
- **路由**: App Router (Next.js)

#### 主要组件
- **角色发现页面**: 角色搜索、浏览、筛选
- **聊天界面**: 文字/语音聊天交互
- **明信片创建**: 多模态内容生成界面
- **用户管理**: 登录、注册、个人资料

#### 关键特性
- 响应式设计，支持移动端和桌面端
- 实时语音录制和播放
- WebSocket实时通信
- 离线缓存支持

### 2. 后端模块 (Backend)

#### 技术栈
- **语言**: Go 1.21+
- **框架**: Gin Web Framework
- **ORM**: GORM (MySQL)
- **缓存**: Redis
- **存储**: MinIO对象存储

#### API设计
```go
// 用户管理
POST /api/v1/auth/login     // 用户登录
POST /api/v1/auth/register  // 用户注册
GET  /api/v1/users/profile  // 获取用户信息

// 角色管理
GET  /api/v1/characters     // 获取角色列表
POST /api/v1/characters     // 创建角色
GET  /api/v1/characters/:id // 获取角色详情

// 明信片管理
POST /api/v1/postcards      // 发送明信片
GET  /api/v1/postcards      // 获取明信片列表
GET  /api/v1/postcards/:id  // 获取明信片详情
```

#### 数据库设计
- **用户表 (users)**: 用户基本信息、偏好设置
- **角色表 (characters)**: AI角色信息、语音配置
- **明信片表 (postcards)**: 对话记录、多媒体内容

### 3. AI代理模块 (Agent)

#### 技术栈
- **语言**: Python 3.9+
- **流程引擎**: PocketFlow
- **LLM集成**: DeepSeek-V3 API
- **语音合成**: 自定义TTS服务
- **消息队列**: RabbitMQ

#### 核心流程节点
1. **消息验证节点**: 验证MQ消息格式
2. **明信片生成节点**: 调用LLM生成回复内容
3. **语音生成节点**: 文本转语音合成
4. **数据保存节点**: 持久化到数据库
5. **状态更新节点**: 更新处理状态

#### 核心功能
- **角色扮演**: 基于角色设定的对话生成
- **语音合成**: 文本转语音功能
- **异步处理**: 消息队列异步处理

## 数据流设计

### 1. 用户发送消息流程
```
用户输入 → 前端收集 → HTTP请求 → 后端验证 → 消息队列 → 
AI代理处理 → LLM生成 → 语音合成 → 数据库保存 → 前端展示
```

### 2. 实时语音聊天流程
```
语音录制 → WebSocket传输 → 语音识别 → 文本处理 → 
角色扮演 → 语音合成 → 实时播放
```

### 3. 异步处理流程
```python
# PocketFlow流程定义
message_processor → postcard_generation → postcard_save → 
voice_generation → voice_update → status_update
```

## 技术特色

### 1. 微服务架构优势
- **解耦性**: 各服务独立部署、扩展
- **容错性**: 单点故障不影响整体系统
- **可维护性**: 模块化设计，易于维护

### 2. 异步处理设计
- **消息队列**: RabbitMQ保证消息可靠性
- **重试机制**: 自动重试失败的操作
- **状态跟踪**: 完整的处理状态监控

### 3. 角色扮演优化
- **提示词工程**: 精心设计的角色提示词
- **上下文管理**: 128K长上下文支持
- **情感一致性**: 保持角色情感表达一致

## 部署架构

### 容器化部署
```yaml
services:
  frontend:    # Next.js前端
  backend:     # Go后端API
  agent:       # Python AI代理
  mysql:       # 数据库
  redis:       # 缓存
  rabbitmq:    # 消息队列
  minio:       # 对象存储
```

### 环境配置
- **开发环境**: 本地Docker Compose
- **测试环境**: 自动化测试流水线
- **生产环境**: Kubernetes集群部署

## 性能优化策略

### 1. 缓存策略
- Redis缓存热点数据
- 数据库查询优化
- 静态资源CDN加速

### 2. 并发处理
- Go协程处理高并发请求
- Python异步IO处理AI任务
- 连接池管理数据库连接

### 3. 监控告警
- 应用性能监控(APM)
- 日志集中管理
- 健康检查机制

## 安全设计

### 1. 认证授权
- JWT Token认证
- 角色权限控制
- API访问限流

### 2. 数据安全
- 数据库加密存储
- 传输数据HTTPS加密
- 敏感信息脱敏处理

### 3. 隐私保护
- 用户数据匿名化
- 对话记录加密存储
- 合规的数据处理流程

## 扩展性设计

### 1. 水平扩展
- 无状态服务设计
- 负载均衡支持
- 数据库分片策略

### 2. 功能扩展
- 插件化架构设计
- API版本管理
- 模块化功能开发

### 3. 集成扩展
- 第三方API集成
- 多LLM提供商支持
- 自定义语音引擎

这个架构设计确保了系统的高可用性、可扩展性和可维护性，为AI角色扮演应用提供了坚实的技术基础。
